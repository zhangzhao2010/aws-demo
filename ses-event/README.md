# SES äº‹ä»¶è½¬å‘ç³»ç»Ÿ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€å¥—å®Œæ•´çš„ **AWS SES é‚®ä»¶äº‹ä»¶è½¬å‘è§£å†³æ–¹æ¡ˆ**ï¼Œå®ç°äº†ä» SES â†’ SNS â†’ Lambda â†’ è‡ªå»º API çš„å®Œæ•´é“¾è·¯ï¼Œæ”¯æŒ **å›ºå®šå‡ºå£ IP ç™½åå•**ã€‚

## ğŸ—ï¸ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AWS Cloud                             â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   SES    â”‚â”€â”€â”€â–¶â”‚  SNS Topic  â”‚â”€â”€â”€â–¶â”‚  Lambda (VPC)    â”‚  â”‚
â”‚  â”‚ å‘é€é‚®ä»¶  â”‚    â”‚   æ¨é€äº‹ä»¶   â”‚    â”‚   ç§æœ‰å­ç½‘        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                               â”‚             â”‚
â”‚                                               â”‚             â”‚
â”‚                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                                      â”‚  NAT Gateway     â”‚  â”‚
â”‚                                      â”‚  å›ºå®šå‡ºå£ IP      â”‚  â”‚
â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â”‚ HTTPS
                                                 â”‚
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚   è‡ªå»º API æœåŠ¡å™¨   â”‚
                                      â”‚  (Java 8 Servlet)  â”‚
                                      â”‚  IP ç™½åå•éªŒè¯      â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
ses-event/
â”œâ”€â”€ lambda/                      # Python Lambda å‡½æ•°
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ handler.py          # ä¸»å¤„ç†å‡½æ•°
â”‚   â”‚   â””â”€â”€ config.py           # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â””â”€â”€ test_event.json     # æµ‹è¯•äº‹ä»¶
â”‚   â”œâ”€â”€ requirements.txt        # Python ä¾èµ–
â”‚   â”œâ”€â”€ README.md              # Lambda æ–‡æ¡£
â”‚   â””â”€â”€ DEPLOYMENT.md          # Lambda éƒ¨ç½²æŒ‡å—
â”‚
â”œâ”€â”€ java/                       # Java Servlet API
â”‚   â”œâ”€â”€ src/main/
â”‚   â”‚   â”œâ”€â”€ java/com/example/sesapi/
â”‚   â”‚   â”‚   â”œâ”€â”€ SesWebhookServer.java      # æœåŠ¡å™¨å¯åŠ¨ç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ SesWebhookServlet.java     # äº‹ä»¶å¤„ç† Servlet
â”‚   â”‚   â”‚   â””â”€â”€ IpWhitelistFilter.java     # IP ç™½åå•è¿‡æ»¤å™¨
â”‚   â”‚   â””â”€â”€ resources/
â”‚   â”‚       â”œâ”€â”€ application.properties      # åº”ç”¨é…ç½®
â”‚   â”‚       â””â”€â”€ logback.xml                # æ—¥å¿—é…ç½®
â”‚   â”œâ”€â”€ pom.xml                            # Maven é…ç½®
â”‚   â”œâ”€â”€ README.md                          # API æ–‡æ¡£
â”‚   â””â”€â”€ DEPLOYMENT.md                      # API éƒ¨ç½²æŒ‡å—
â”‚
â”œâ”€â”€ prompt.md                   # æ–¹æ¡ˆè®¾è®¡æ–‡æ¡£
â””â”€â”€ README.md                   # æœ¬æ–‡ä»¶
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶

- **AWS è´¦å·**ï¼ˆå·²é…ç½® SESã€SNSã€Lambdaã€VPCï¼‰
- **NAT Gateway**ï¼ˆå·²åˆ†é…å›ºå®š Elastic IPï¼‰
- **Python 3.13**ï¼ˆLambda å¼€å‘ï¼‰
- **Java 8+** å’Œ **Maven 3.6+**ï¼ˆAPI å¼€å‘ï¼‰

### ç¬¬ä¸€æ­¥ï¼šéƒ¨ç½² Lambda å‡½æ•°

```bash
cd lambda

# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt -t ./package

# 2. æ‰“åŒ…éƒ¨ç½²
cp -r src/* package/
cd package && zip -r ../lambda-deployment.zip . && cd ..

# 3. ä¸Šä¼ åˆ° AWS Lambdaï¼ˆå‚è€ƒ lambda/DEPLOYMENT.mdï¼‰
```

**è¯¦ç»†æ­¥éª¤è¯·æŸ¥çœ‹**ï¼š[lambda/DEPLOYMENT.md](./lambda/DEPLOYMENT.md)

### ç¬¬äºŒæ­¥ï¼šéƒ¨ç½² Java API

```bash
cd java

# 1. ç¼–è¯‘æ‰“åŒ…
mvn clean package

# 2. è¿è¡ŒæœåŠ¡å™¨
java -jar target/ses-webhook-api-1.0.0.jar
```

**è¯¦ç»†æ­¥éª¤è¯·æŸ¥çœ‹**ï¼š[java/DEPLOYMENT.md](./java/DEPLOYMENT.md)

### ç¬¬ä¸‰æ­¥ï¼šé…ç½® Lambda ç¯å¢ƒå˜é‡

```bash
# è®¾ç½®è‡ªå»º API åœ°å€
export API_ENDPOINT="https://your-api.com/ses/webhook"

# æˆ–åœ¨ AWS Console é…ç½®
# Lambda â†’ Configuration â†’ Environment variables
# API_ENDPOINT = https://your-api.com/ses/webhook
```

### ç¬¬å››æ­¥ï¼šæµ‹è¯•å®Œæ•´é“¾è·¯

#### 1. æµ‹è¯• Java API

```bash
curl -X POST http://localhost:8080/ses/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "notificationType": "Delivery",
    "mail": {"messageId": "test-123"}
  }'
```

#### 2. é€šè¿‡ SES å‘é€æµ‹è¯•é‚®ä»¶

åœ¨ AWS Consoleï¼š**SES â†’ Email Testing â†’ Send Test Email**

#### 3. æŸ¥çœ‹æ—¥å¿—

**Lambda æ—¥å¿—ï¼ˆCloudWatchï¼‰**ï¼š

```
[INFO] æ”¶åˆ° SES äº‹ä»¶ - Type: Delivery, MessageId: abc123
[INFO] æˆåŠŸè½¬å‘äº‹ä»¶åˆ° API - Type: Delivery, Status: 200
```

**Java API æ—¥å¿—**ï¼š

```bash
tail -f java/logs/ses-events-only.log
```

## ğŸ“š æŠ€æœ¯æ ˆ

### Lambda ç«¯

- **Python 3.13**
- **requests** - HTTP å®¢æˆ·ç«¯
- **boto3** - AWS SDKï¼ˆè¿è¡Œæ—¶æä¾›ï¼‰

### API ç«¯

- **Java 8**
- **Servlet 3.1** - åŸç”Ÿ Servlet API
- **Jetty 9.4** - åµŒå…¥å¼ Web æœåŠ¡å™¨
- **Gson** - JSON è§£æ
- **SLF4J + Logback** - æ—¥å¿—æ¡†æ¶

## ğŸ”‘ æ ¸å¿ƒç‰¹æ€§

### âœ… Lambda åŠŸèƒ½

- âœ… **è‡ªåŠ¨å¤„ç† SNS è®¢é˜…ç¡®è®¤**ï¼ˆSubscriptionConfirmationï¼‰
- âœ… æ¥æ”¶ SNS æ¨é€çš„ SES äº‹ä»¶
- âœ… è§£æ 6 ç§äº‹ä»¶ç±»å‹ï¼ˆDelivery/Bounce/Complaint/Reject/Open/Clickï¼‰
- âœ… è½¬å‘åˆ°è‡ªå»º API
- âœ… å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼ˆç”± SNS è§¦å‘ï¼‰
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•

### âœ… Java API åŠŸèƒ½

- âœ… è½»é‡çº§ Servlet å®ç°ï¼ˆæ— éœ€é¢å¤–æ¡†æ¶ï¼‰
- âœ… äº‹ä»¶å†™å…¥æ—¥å¿—æ–‡ä»¶ï¼ˆæ”¯æŒè‡ªåŠ¨æ»šåŠ¨ï¼‰
- âœ… ç‹¬ç«‹çš„ SES äº‹ä»¶æ—¥å¿—ï¼ˆæ–¹ä¾¿åˆ†æï¼‰
- âœ… JSON æ ¼å¼åŒ–è¾“å‡º
- âœ… æ”¯æŒ X-Forwarded-Forï¼ˆåå‘ä»£ç†åœºæ™¯ï¼‰
- âœ… ä¼˜é›…çš„é”™è¯¯å¤„ç†

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

1. **å›ºå®šå‡ºå£ IP**ï¼šLambda é€šè¿‡ NAT Gateway ä»¥å›ºå®š IP è®¿é—® API
2. **VPC éš”ç¦»**ï¼šLambda éƒ¨ç½²åœ¨ç§æœ‰å­ç½‘ï¼Œæ— å…¬ç½‘è®¿é—®
3. **HTTPS æ”¯æŒ**ï¼šLambda ä½¿ç”¨ TLS éªŒè¯è¯ä¹¦
4. **å¯æ‰©å±•çš„è®¿é—®æ§åˆ¶**ï¼šAPI ç«¯å¯é…ç½®é˜²ç«å¢™æˆ– Nginx è¿›è¡Œè®¿é—®æ§åˆ¶

## ğŸ“Š ç›‘æ§å’Œè¿ç»´

### Lambda ç›‘æ§

- **CloudWatch Logs**ï¼šæŸ¥çœ‹æ‰§è¡Œæ—¥å¿—
- **CloudWatch Metrics**ï¼šç›‘æ§è°ƒç”¨æ¬¡æ•°ã€é”™è¯¯ç‡ã€æŒç»­æ—¶é—´
- **X-Ray**ï¼ˆå¯é€‰ï¼‰ï¼šåˆ†å¸ƒå¼è·Ÿè¸ª

### API ç›‘æ§

- **æ—¥å¿—æ–‡ä»¶**ï¼š
  - `logs/ses-events.log` - æ‰€æœ‰ç³»ç»Ÿæ—¥å¿—
  - `logs/ses-events-only.log` - ä»… SES äº‹ä»¶
- **æ—¥å¿—æ»šåŠ¨**ï¼šæŒ‰å¤©åˆ‡åˆ†ï¼Œä¿ç•™ 30 å¤©
- **è¿›ç¨‹ç›‘æ§**ï¼šä½¿ç”¨ systemd æˆ– supervisor

## ğŸ“– è¯¦ç»†æ–‡æ¡£

| ç»„ä»¶ | åŠŸèƒ½è¯´æ˜ | éƒ¨ç½²æŒ‡å— |
|------|---------|---------|
| **Lambda** | SES äº‹ä»¶è½¬å‘å‡½æ•° | [lambda/README.md](./lambda/README.md) <br> [lambda/DEPLOYMENT.md](./lambda/DEPLOYMENT.md) |
| **Java API** | è‡ªå»ºäº‹ä»¶æ¥æ”¶æœåŠ¡å™¨ | [java/README.md](./java/README.md) <br> [java/DEPLOYMENT.md](./java/DEPLOYMENT.md) |

## ğŸ› æ•…éšœæ’æŸ¥

### Lambda æ— æ³•è°ƒç”¨ API

**å¯èƒ½åŸå› **ï¼š
1. NAT Gateway æœªæ­£ç¡®é…ç½®
2. è·¯ç”±è¡¨æœªæŒ‡å‘ NAT Gateway
3. Security Group æœªå¼€æ”¾å‡ºç«™ 443

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥è·¯ç”±è¡¨
aws ec2 describe-route-tables --route-table-id rtb-xxx

# ç¡®ä¿ç§æœ‰å­ç½‘è·¯ç”±åˆ° NAT Gateway
# 0.0.0.0/0 â†’ nat-xxxxxx
```

### SES äº‹ä»¶æœªé€è¾¾

**å¯èƒ½åŸå› **ï¼š
1. SES Configuration Set æœªæ­£ç¡®é…ç½®
2. SNS Subscription æœªç¡®è®¤
3. Lambda æƒé™ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ SNS Subscription çŠ¶æ€
aws sns list-subscriptions-by-topic \
  --topic-arn arn:aws:sns:region:account:ses-events-topic

# ç¡®ä¿çŠ¶æ€ä¸º "ConfirmedSubscriptionArn"
```

## ğŸ’¡ æœ€ä½³å®è·µ

1. **é«˜å¯ç”¨éƒ¨ç½²**ï¼š
   - Lambdaï¼šå¤š AZ éƒ¨ç½²ï¼ˆè‡ªåŠ¨ï¼‰
   - NAT Gatewayï¼šæ¯ä¸ª AZ ä¸€ä¸ª
   - APIï¼šä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨

2. **æ—¥å¿—ç®¡ç†**ï¼š
   - Lambdaï¼šCloudWatch Logs Insights åˆ†æ
   - APIï¼šå®šæœŸå½’æ¡£æˆ–ä¼ è¾“åˆ° S3

3. **æˆæœ¬ä¼˜åŒ–**ï¼š
   - Lambdaï¼šæŒ‰éœ€ä»˜è´¹ï¼Œæ— é—²ç½®æˆæœ¬
   - NAT Gatewayï¼šä½¿ç”¨ NAT Instance é™ä½æˆæœ¬ï¼ˆéç”Ÿäº§ç¯å¢ƒï¼‰

4. **ç›‘æ§å‘Šè­¦**ï¼š
   - Lambda é”™è¯¯ç‡ > 5%
   - API å“åº”æ—¶é—´ > 5s
   - æ—¥å¿—ç£ç›˜ä½¿ç”¨ > 80%

## ğŸ¯ æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| Lambda æ‰§è¡Œæ—¶é—´ | < 3s | åŒ…å« API è°ƒç”¨ |
| API å“åº”æ—¶é—´ | < 500ms | ä»…å†™æ—¥å¿—æ“ä½œ |
| äº‹ä»¶ä¸¢å¤±ç‡ | 0% | SNS è‡ªåŠ¨é‡è¯• |
| æ—¥å¿—å»¶è¿Ÿ | < 1s | å®æ—¶å†™å…¥ |

## ğŸ†˜ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æŒ‰ä»¥ä¸‹é¡ºåºæ£€æŸ¥ï¼š

1. âœ… æŸ¥çœ‹ Lambda æ—¥å¿—ï¼šCloudWatch Logs
2. âœ… æŸ¥çœ‹ API æ—¥å¿—ï¼š`java/logs/ses-events.log`
3. âœ… æ£€æŸ¥ç½‘ç»œè¿é€šæ€§ï¼š`curl` æµ‹è¯•
4. âœ… æ£€æŸ¥ AWS IAM æƒé™
5. âœ… éªŒè¯ SNS è®¢é˜…çŠ¶æ€

## ğŸ“„ è®¸å¯è¯

MIT License

---

## ğŸ‰ æ€»ç»“

ä½ ç°åœ¨æ‹¥æœ‰ä¸€å¥—**ç”Ÿäº§çº§ã€å¯ç›´æ¥éƒ¨ç½²ã€åŠŸèƒ½å®Œæ•´**çš„ SES äº‹ä»¶è½¬å‘ç³»ç»Ÿï¼š

- ğŸ” **å®‰å…¨**ï¼šVPC éš”ç¦» + å›ºå®šå‡ºå£ IP
- ğŸ” **å¯é **ï¼šSNS è‡ªåŠ¨é‡è¯• + è®¢é˜…ç¡®è®¤
- ğŸ§± **ç¨³å®š**ï¼šVPC ç§æœ‰å­ç½‘éš”ç¦»
- ğŸ“¡ **å®Œæ•´**ï¼šæ”¯æŒæ‰€æœ‰ SES äº‹ä»¶ç±»å‹
- ğŸ’» **æ˜“ç”¨**ï¼šè¯¦ç»†æ–‡æ¡£ + å¼€ç®±å³ç”¨
- ğŸš€ **ç®€æ´**ï¼šè½»é‡çº§å®ç°ï¼Œæ— å†—ä½™åŠŸèƒ½

**Happy Coding!** ğŸš€
